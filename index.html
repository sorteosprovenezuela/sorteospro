<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sorteos PRO Venezuela</title>
  <!-- Favicon inline para evitar 404 -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéüÔ∏è</text></svg>">
  <meta name="color-scheme" content="dark light" />
  <link rel="preload" href="assets/promo.jpg" as="image" />

  <style>
    :root{
      --bg:#0c0f12; --card:#12161b; --muted:#8892a6; --text:#e7edf5;
      --acc:#16a34a; --acc-2:#f59e0b; --danger:#ef4444; --ring:#1f2937;
      --input:#0f1419; --border:#1f2833;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",Arial,"Apple Color Emoji","Segoe UI Emoji";}

    .container{max-width:1100px;margin:auto;padding:16px;}

    header{display:flex;justify-content:space-between;align-items:center;padding:12px 0}
    header img{height:36px}
    .btn{display:inline-flex;align-items:center;gap:.5rem; padding:.9rem 1.1rem;border:1px solid #2a3542;border-radius:12px;background:#0c1116;color:#e7edf5;cursor:pointer}
    .btn:hover{background:#0e1319}
    .btn.primary{background:var(--acc);border-color:var(--acc);color:#08130a}
    .btn.primary:hover{filter:brightness(1.05)}
    .btn.warning{background:#1b1306;border-color:#3a2a07;color:#ffdfa6}
    .btn.inline{padding:.5rem .8rem;border-radius:10px;font-size:.9rem}

    .hero{position:relative;border:1px solid var(--border);border-radius:18px;overflow:hidden;background:#0b0f14}
    .hero img{width:100%;height:auto;display:block;object-fit:cover;aspect-ratio:16/9}
    .hero .overlay{position:absolute;inset:auto 0 0 0; padding:14px; display:flex;justify-content:flex-end}
    .chip{font-size:.85rem;border:1px solid #374151;background:#0f172a;color:#d1d5db;border-radius:12px;padding:.4rem .7rem}

    .grid{display:grid;gap:14px;margin-top:16px}
    @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }

    .card{border:1px solid var(--border);border-radius:16px;background:var(--card);padding:16px}
    .h1{font-size:1.6rem;margin:0 0 .5rem}
    .muted{color:var(--muted)}
    .price{font-weight:700;color:#a7f3d0}

    .row{display:flex;gap:10px;align-items:center}
    .row .btn{flex:1}

    /* ===== Modal ===== */
    dialog{border:none;border-radius:18px;max-width:920px;width:calc(100% - 20px);background:var(--card);color:var(--text);padding:0}
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border)}
    .modal-title{font-weight:700}
    .modal-body{padding:16px}
    .grid-3{display:grid;gap:12px}
    @media(min-width:1000px){ .grid-3{grid-template-columns:400px 1fr} }

    .box{border:1px solid var(--border);border-radius:14px;padding:14px;background:#0c1116}
    .box h3{margin:0 0 8px;font-size:1rem}
    .field{display:flex;flex-direction:column;gap:6px;margin:8px 0}
    .field label{font-size:.86rem;color:var(--muted)}
    .input,
    select{border:1px solid #253140;background:var(--input);color:var(--text);padding:.8rem;border-radius:12px;outline:none}
    .input:focus, select:focus{border-color:#3b82f6; box-shadow:0 0 0 4px rgba(59,130,246,.15)}
    input[type="file"]{background:transparent}
    .help{font-size:.8rem;color:var(--muted)}

    .footer-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
    .err{display:none;margin-top:10px;border:1px solid #3c0d0d;background:#180707;color:#ffb4b4;padding:.8rem .9rem;border-radius:12px}

    /* Resultado asignaci√≥n */
    .result-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:12px;z-index:60}
    .result-card{max-width:720px;width:100%;background:#0c1116;border:1px solid var(--border);border-radius:18px;padding:16px}
    .badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .badge{background:#0e1b0f;border:1px solid #1f3c22;color:#a7f3d0;border-radius:12px;padding:.5rem .7rem;font-weight:700}

    .hide{display:none !important}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="row" style="gap:10px">
        <img src="assets/logo.png" alt="Sorteos PRO" />
        <span class="muted">Sorteos PRO Venezuela</span>
      </div>
      <a class="btn inline" href="https://t.me/+58XXXXXXXXXX" target="_blank" rel="noopener">Telegram</a>
    </header>

    <section class="hero">
      <img src="assets/promo.jpg" alt="Promoci√≥n" decoding="async" />
      <div class="overlay">
        <span class="chip">Loter√≠a de Supergana ‚Ä¢ 13 Oct 2025</span>
      </div>
    </section>

    <section class="grid">
      <div class="card">
        <h1 class="h1">Sorteo <span class="price">US$ 10.000</span></h1>
        <p class="muted">Tickets a <strong>Bs. 489</strong></p>

        <div class="row" style="margin-top:12px">
          <button id="btn1" class="btn">1</button>
          <button id="btn2" class="btn">2</button>
          <button id="btn10" class="btn">10</button>
          <button id="btn25" class="btn">25</button>
        </div>

        <p class="muted" style="margin-top:10px">Total a pagar: <strong>Bs. <span id="total">489</span></strong></p>

        <div class="row" style="margin-top:10px">
          <button id="participar" class="btn primary" style="font-size:1rem">Participar</button>
          <a class="btn warning" href="https://wa.me/584244150022" target="_blank" rel="noopener">WhatsApp soporte</a>
        </div>

        <p class="help" style="margin-top:10px">Al continuar, ver√°s los datos del Pago M√≥vil, subir√°s tu captura y recibir√°s <em>al instante</em> tus n√∫meros aleatorios. Si el pago no coincide, el administrador puede liberarlos.</p>
      </div>

      <div class="card">
        <h2 class="h1" style="font-size:1.2rem">Detalles del sorteo</h2>
        <ul class="muted" style="line-height:1.7;margin:0;padding-left:16px">
          <li>Fecha del sorteo: <strong>13/10/2025</strong></li>
          <li>Premio: <strong>US$ 10.000</strong></li>
          <li>N√∫meros disponibles: 0000‚Äì9999</li>
          <li>Asignaci√≥n autom√°tica al reportar tu pago</li>
        </ul>
      </div>
    </section>
  </div>

  <!-- ============ MODAL ============ -->
  <dialog id="modal">
    <div class="modal-header">
      <div class="modal-title">Pago M√≥vil</div>
      <button class="btn inline" onclick="closeModal()">Cerrar</button>
    </div>

    <div class="modal-body grid-3">
      <!-- Columna izquierda: Beneficiario -->
      <div class="box">
        <h3>1) Datos del beneficiario</h3>
        <div class="field"><label>Monto exacto</label><div class="input" id="priceBox">Bs. <span id="price">489</span></div></div>
        <div class="field"><label>Banco</label><div class="input">Banco Provincial</div></div>
        <div class="field"><label>Tel√©fono</label><div class="input">04244150022</div></div>
        <div class="field"><label>C√©dula</label><div class="input">15857050</div></div>
        <p class="help">Haz el Pago M√≥vil por el monto exacto y guarda el comprobante.</p>
      </div>

      <!-- Columna derecha: Comprobante + Datos del pagador -->
      <div class="box">
        <h3>2) Sube tu comprobante</h3>
        <div class="field">
          <label>Archivo (JPG/PNG/HEIC, m√°x. 5 MB)</label>
          <input class="input" type="file" id="file" accept=".jpg,.jpeg,.png,.heic,image/*" />
          <p class="help">Arrastra o selecciona el archivo del comprobante.</p>
        </div>

        <h3 style="margin-top:10px">3) Reporta tu pago</h3>

        <div class="field">
          <label>Banco emisor</label>
          <select id="bank" class="input">
            <option>Banco de Venezuela</option>
            <option>Banco Provincial</option>
            <option>Banco Mercantil</option>
            <option>Banco Banesco</option>
            <option>Otro</option>
          </select>
        </div>

        <div class="field">
          <label>C√©dula (solo n√∫meros)</label>
          <input id="ci" class="input" inputmode="numeric" placeholder="Ej: 15857060" />
        </div>

        <div class="field">
          <label>Tel√©fono</label>
          <input id="tlf" class="input" inputmode="numeric" placeholder="Ej: 04125093287" />
        </div>

        <div class="field">
          <label>√öltimos 6 de la referencia</label>
          <input id="ref6" class="input" inputmode="numeric" maxlength="6" placeholder="Ej: 358412" />
        </div>

        <div class="field">
          <label>Fecha del pago</label>
          <input id="date" class="input" type="date" />
        </div>

        <div class="field">
          <label>Hora del pago</label>
          <div style="display:flex;gap:8px">
            <input id="hh" class="input" inputmode="numeric" maxlength="2" placeholder="HH" style="width:90px" />
            <input id="mm" class="input" inputmode="numeric" maxlength="2" placeholder="MM" style="width:90px" />
          </div>
        </div>

        <div id="err" class="err"></div>

        <div class="footer-actions">
          <button id="payBtn" class="btn primary">Confirmar y obtener n√∫meros ahora</button>
        </div>
        <p class="help">Asignaci√≥n inmediata. Si el pago no coincide, el administrador puede liberar los n√∫meros.</p>
      </div>
    </div>
  </dialog>

  <!-- ============ RESULTADO ============ -->
  <div id="overlay" class="result-overlay">
    <div class="result-card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <h3 style="margin:0">¬°Listo, n√∫meros asignados üéâ!</h3>
        <button class="btn inline" onclick="closeModal()">Cerrar</button>
      </div>
      <p class="help">Haz captura y cons√©rvala.</p>
      <div id="nums" class="badges"></div>
      <div class="footer-actions" style="margin-top:12px">
        <button class="btn" onclick="navigator.clipboard.writeText(document.getElementById('nums').innerText)">Copiar</button>
        <button class="btn primary" onclick="closeModal()">Volver al inicio</button>
      </div>
    </div>
  </div>

  <script>
    /* ================== CONFIG ================== */
    // üëâ Si despliegas otra versi√≥n del Apps Script, cambia esta URL por la nueva que termine en /exec
    const API = "https://script.google.com/macros/s/AKfycbyfe88_IsXQIXl3bZ5Rnh9u8bHCkAUCKny913UlWngl8hBdQKGRE1XG2_85gxw37w0/exec";
    const RAFFLE_ID = "raffle-001";
    const PRICE_BS  = 489;

    const modal = document.getElementById("modal");
    const overlay = document.getElementById("overlay");
    const numsBox = document.getElementById("nums");
    const errBox  = document.getElementById("err");
    const btnPay  = document.getElementById("payBtn");

    // Cantidades r√°pidas
    const totalEl = document.getElementById("total");
    const priceEl = document.getElementById("price");
    document.getElementById("btn1").onclick  = ()=>{ totalEl.textContent = PRICE_BS; };
    document.getElementById("btn2").onclick  = ()=>{ totalEl.textContent = PRICE_BS*2; };
    document.getElementById("btn10").onclick = ()=>{ totalEl.textContent = PRICE_BS*10; };
    document.getElementById("btn25").onclick = ()=>{ totalEl.textContent = PRICE_BS*25; };
    document.getElementById("participar").onclick = ()=>{ modal.showModal(); };

    // Fecha/hora por defecto + precio
    (function initDate(){
      const d=new Date();
      const yyyy=d.getFullYear(),mm=String(d.getMonth()+1).padStart(2,"0"),dd=String(d.getDate()).padStart(2,"0");
      document.getElementById("date").value=`${yyyy}-${mm}-${dd}`;
      document.getElementById("hh").value=String(d.getHours()).padStart(2,"0");
      document.getElementById("mm").value=String(d.getMinutes()).padStart(2,"0");
      totalEl.textContent = PRICE_BS;
      priceEl.textContent = PRICE_BS;
    })();

    function showErr(m){ errBox.textContent=m; errBox.style.display="block"; }
    function clearErr(){ errBox.textContent=""; errBox.style.display="none"; }
    function closeModal(){
      modal.close();
      overlay.style.display="none";
      window.scrollTo({top:0,behavior:"smooth"});
    }
    window.closeModal = closeModal;

    // Anti-doble env√≠o (20s)
    const SUBMIT_WINDOW_S = 20;
    function canSubmit(){
      const k="lastSubmitAt";
      const now=Date.now();
      const last=Number(localStorage.getItem(k)||0);
      if(now-last < SUBMIT_WINDOW_S*1000) return false;
      localStorage.setItem(k,String(now));
      return true;
    }

    async function submitOrder(){
      clearErr();
      if(!canSubmit()){ showErr("Ya estamos procesando tu pago. Espera unos segundos‚Ä¶"); return; }

      const file = document.getElementById("file").files[0] || null;
      const bank = document.getElementById("bank").value.trim();
      const ci   = document.getElementById("ci").value.trim();
      const tlf  = document.getElementById("tlf").value.trim();
      const ref6 = document.getElementById("ref6").value.trim();
      const date = document.getElementById("date").value.trim();
      const hh   = document.getElementById("hh").value.trim();
      const mm   = document.getElementById("mm").value.trim();

      if(!file){ showErr("Debes subir el comprobante (JPG/PNG/HEIC, m√°x. 5 MB)."); return; }
      if(!/^\d{6}$/.test(ref6)){ showErr("Los √∫ltimos 6 d√≠gitos de la referencia no son v√°lidos."); return; }
      if(!/^\d{6,10}$/.test(ci)){ showErr("La c√©dula debe ser num√©rica (6-10 d√≠gitos)."); return; }
      if(!/^\d{10,12}$/.test(tlf)){ showErr("El tel√©fono debe ser num√©rico (10-12 d√≠gitos)."); return; }
      if(!/^\d{2}$/.test(hh)||!/^\d{2}$/.test(mm)){ showErr("Hora inv√°lida. Usa HH y MM."); return; }

      btnPay.disabled = true; btnPay.textContent = "Procesando‚Ä¶";

      try{
        const fd = new FormData();
        fd.append("action","createOrder");
        fd.append("raffleId", RAFFLE_ID);
        fd.append("priceBs", String(PRICE_BS));
        fd.append("bank", bank);
        fd.append("ci", ci);
        fd.append("tlf", tlf);
        fd.append("ref6", ref6);
        fd.append("date", date);
        fd.append("time", `${hh}:${mm}`);
        fd.append("file", file, file.name);

        const res = await fetch(`${API}?t=${Date.now()}`, { method:"POST", body:fd });
        const text = await res.text().catch(()=> "");
        if(!res.ok){
          console.error("Apps Script error:", res.status, res.statusText, text);
          throw new Error(`Servidor respondi√≥ ${res.status}. ${text||"Intenta de nuevo."}`);
        }
        let data={};
        try{ data = JSON.parse(text); }catch(_){
          console.error("Respuesta no-JSON:", text);
          throw new Error("Respuesta del servidor inv√°lida.");
        }
        if(!data.ok){
          console.error("Apps Script dijo !ok:", data);
          throw new Error(data.message || "No se pudo registrar el pago.");
        }

        // Mostrar n√∫meros asignados
        numsBox.innerHTML="";
        (data.numbers||[]).forEach(n=>{
          const b=document.createElement("div");
          b.className="badge";
          b.textContent=String(n).padStart(4,"0");
          numsBox.appendChild(b);
        });
        overlay.style.display="flex";

      }catch(e){
        showErr(e.message || "Error inesperado. Reintenta.");
      }finally{
        btnPay.disabled = false; btnPay.textContent = "Confirmar y obtener n√∫meros ahora";
      }
    }

    document.getElementById("payBtn").addEventListener("click", submitOrder);
  </script>
</body>
</html>
