<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sorteos PRO Venezuela — US$ 10.000</title>
<meta name="description" content="Participa por US$ 10.000. Tickets a Bs. 489. Sorteo 13/10/2025 por Lotería de Supergana.">
<style>
  :root{--bg:#0b0d0f;--bg2:#0e1114;--card:#12161b;--border:#1f2937;--text:#e5e7eb;--muted:#9aa6b2;--gold:#D4AF37;--green:#16a34a;--radius:16px;--shadow:0 8px 30px rgba(0,0,0,.35)}
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
  a{color:inherit;text-decoration:none} img{max-width:100%;display:block}
  header{position:sticky;top:0;z-index:10;background:rgba(0,0,0,.5);backdrop-filter:blur(6px);border-bottom:1px solid #151a21}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .nav{display:flex;align-items:center;justify-content:space-between}
  .btn{appearance:none;border:1px solid var(--gold);background:transparent;color:var(--gold);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn.solid{background:var(--green);border-color:var(--green);color:#fff}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .grid{display:grid;gap:16px}
  .hero{grid-template-columns:1fr 380px}
  @media (max-width:960px){.hero{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid #233042;background:#0b1117;color:#cbd5e1;padding:6px 10px;border-radius:999px;font-size:12px}
  h1{margin:8px 0 6px;font-size:clamp(22px,5vw,34px)} .lead{color:#c7cad1} .gold{color:var(--gold)}
  .kv{display:flex;gap:10px;align-items:center;font-size:14px;color:#cbd5e1} .divider{height:1px;background:#1f2937;margin:12px 0}
  .qty{display:flex;gap:10px;align-items:center;flex-wrap:wrap} .box{display:flex;align-items:center;border:1px solid #283241;background:#0c111b;border-radius:12px;padding:8px}
  .box input{all:unset;width:86px;text-align:center;font-variant-numeric:tabular-nums;font-weight:800}
  .chips{display:grid;grid-template-columns:repeat(6,minmax(60px,1fr));gap:8px}
  @media (max-width:560px){.chips{grid-template-columns:repeat(3,1fr)}}
  .chip{padding:12px;border-radius:12px;background:#0e141c;border:1px solid #253245;text-align:center;cursor:pointer;font-weight:700}
  .price{font-weight:800;font-size:clamp(22px,3.5vw,28px);color:var(--gold)}
  .list{display:grid;gap:8px} .item{display:flex;justify-content:space-between;gap:8px;border:1px solid var(--border);background:#0c111b;border-radius:12px;padding:10px}
  .muted{color:#a7abb3;font-size:13px}
  .thumb{border-radius:14px;overflow:hidden;aspect-ratio:16/9;background:#0a0a0a}
  .thumb img{width:100%;height:100%;object-fit:cover}
  dialog{border:none;border-radius:18px;background:#0c1116;color:#fff;max-width:980px;width:calc(100% - 24px);box-shadow:var(--shadow)}
  dialog::backdrop{background:rgba(0,0,0,.7)}
  .modal-head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #1a2432}
  .modal-body{padding:16px}
  label{display:block;margin:6px 0 4px;color:#cbd5e1} input,select{width:100%;background:#0d121a;border:1px solid #273244;color:#fff;padding:12px;border-radius:10px}
  .two{display:grid;gap:12px} .three{display:grid;gap:12px}
  @media (min-width:700px){.two{grid-template-columns:1fr 1fr}} @media (min-width:860px){.three{grid-template-columns:1fr 1fr 1fr}}
  .note{background:#0b1219;border:1px dashed #2a3649;color:#cbd5e1;border-radius:12px;padding:10px;font-size:13px}
  .ticket{padding:12px;border:1px solid #1f2937;border-radius:12px;background:#0d1219;text-align:center;font-weight:800;letter-spacing:.12em}
</style>
</head>
<body>
<header>
  <div class="wrap nav">
    <div style="display:flex;gap:10px;align-items:center">
      <img src="./assets/logo.png" alt="Sorteos PRO" style="height:34px" onerror="this.style.display='none'">
      <b>Sorteos PRO</b>
    </div>
    <a class="btn" href="#" id="tgBtn">Telegram</a>
  </div>
</header>

<div class="wrap grid hero" style="margin-top:14px">
  <section class="card">
    <div class="thumb">
      <img src="./assets/hero.jpg"
           alt="Promo del sorteo"
           onerror="this.src='https://images.unsplash.com/photo-1540575467063-178a50c2df87?q=80&w=1200&auto=format&fit=crop'">
    </div>
    <div style="padding:12px 6px 4px">
      <span class="pill">Lotería de Supergana • 13 Oct 2025</span>
      <h1>Sorteo <span class="gold">US$ 10.000</span></h1>
      <div class="lead">Tickets a <span class="gold">Bs. 489</span>. 10.000 números únicos (0000–9999).</div>
    </div>
    <div class="divider"></div>

    <div style="padding:6px 6px 14px">
      <div class="kv"><b class="gold">Elige tus boletos</b></div>
      <div class="qty" style="margin:10px 0 10px">
        <div class="box">
          <button id="minus" class="btn" style="padding:8px 12px">−</button>
          <input id="qty" type="text" inputmode="numeric" value="1">
          <button id="plus" class="btn" style="padding:8px 12px">+</button>
        </div>
      </div>
      <div class="chips" style="margin-bottom:10px">
        <div class="chip" data-q="1">1</div>
        <div class="chip" data-q="2">2<br><span class="muted">Popular</span></div>
        <div class="chip" data-q="5">5</div>
        <div class="chip" data-q="10">10</div>
        <div class="chip" data-q="25">25</div>
        <div class="chip" data-q="50">50</div>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div>
          <div class="muted">Total a pagar</div>
          <div class="price" id="total">Bs. 489</div>
        </div>
        <button id="participar" class="btn solid" disabled>Participar</button>
      </div>
      <p class="note" style="margin-top:10px">
        Al continuar verás los datos del Pago Móvil, subirás tu captura y recibirás <b>al instante</b> tus números aleatorios. Si el pago no coincide, el administrador puede liberarlos.
      </p>
      <div class="muted" id="authState" style="margin-top:6px;font-size:12px">Conectando a Firebase…</div>
    </div>
  </section>

  <aside class="card">
    <p style="margin:0 0 6px;font-weight:800">Detalles del sorteo</p>
    <div class="list">
      <div class="item"><span>Premio</span><b>US$ 10.000</b></div>
      <div class="item"><span>Fecha</span><b>13/10/2025</b></div>
      <div class="item"><span>Organiza</span><b>Lotería de Supergana</b></div>
      <div class="item"><span>Números</span><b>0000–9999</b></div>
      <div class="item"><span>Precio</span><b>Bs. 489</b></div>
    </div>
  </aside>
</div>

<footer class="wrap" style="margin-top:20px;color:#9aa6b2;font-size:13px">© 2025 Sorteos PRO Venezuela</footer>

<!-- MODAL DATOS -->
<dialog id="modal-datos">
  <div class="modal-head">
    <strong>Indica tus datos</strong>
    <button class="btn" onclick="closeModal('modal-datos')">Cerrar</button>
  </div>
  <div class="modal-body">
    <form id="form-datos" class="two" onsubmit="return false;">
      <div><label>Nombre completo</label><input id="nombre" placeholder="Ej.: Juan Pérez" required></div>
      <div><label>Correo electrónico</label><input id="correo" type="email" placeholder="tu@correo.com" required></div>
      <div><label>Cédula (solo números)</label><input id="ci" inputmode="numeric" maxlength="10" required></div>
      <div><label>Teléfono</label><input id="tlf" inputmode="tel" maxlength="12" required></div>
    </form>
    <div style="display:flex;gap:10px;justify-content:end;margin-top:12px">
      <button class="btn" onclick="closeModal('modal-datos')">Cancelar</button>
      <button id="ir-pago" class="btn solid">Continuar al pago</button>
    </div>
  </div>
</dialog>

<!-- MODAL PAGO -->
<dialog id="modal-pago">
  <div class="modal-head">
    <strong>Pago Móvil</strong>
    <button class="btn" onclick="closeModal('modal-pago')">Cerrar</button>
  </div>
  <div class="modal-body three">
    <div class="card">
      <h3 style="margin:0 0 6px">1) Datos del beneficiario</h3>
      <div class="item"><span>Monto exacto</span><b id="monto-exacto">Bs. 0</b></div>
      <div class="item"><span>Banco</span><b>Banco Provincial</b></div>
      <div class="item"><span>Teléfono</span><b>04244150022</b></div>
      <div class="item"><span>Cédula</span><b>15857050</b></div>
      <p class="muted" style="font-size:12px">Haz el Pago Móvil por el monto exacto y guarda el comprobante.</p>
    </div>

    <div class="card">
      <h3 style="margin:0 0 6px">2) Sube tu comprobante</h3>
      <input id="file" type="file" accept="image/*">
      <div class="muted" style="font-size:12px;margin-top:6px">JPG/PNG/HEIC – máx 5 MB</div>
    </div>

    <form id="form-reporte" class="card" onsubmit="return false;">
      <h3 style="margin:0 0 6px">3) Reporta tu pago</h3>
      <label>Banco emisor</label>
      <select id="banco-emisor" required>
        <option>Banco de Venezuela</option><option>Banco Provincial</option><option>Banco Mercantil</option>
        <option>Banesco</option><option>BNC</option><option>Bancamiga</option><option>Mi Banco</option>
      </select>
      <label>Cédula (solo números)</label>
      <input id="ci-emisor" inputmode="numeric" maxlength="10" required>
      <label>Teléfono</label>
      <input id="tlf-emisor" inputmode="tel" maxlength="12" required>
      <label>Últimos 6 de la referencia</label>
      <input id="ref6" inputmode="numeric" pattern="\d{6}" maxlength="6" required>
      <label>Fecha del pago</label>
      <input id="fecha" type="date" required>
      <div class="divider"></div>
      <button id="confirmar" class="btn solid" style="width:100%">Confirmar y obtener números ahora</button>
      <div class="muted" id="fireNote" style="margin-top:6px;display:none">Firestore listo.</div>
    </form>
  </div>
</dialog>

<!-- MODAL OK -->
<dialog id="modal-ok">
  <div class="modal-head">
    <strong>Compra aprobada 🎉</strong>
    <button class="btn" onclick="closeModal('modal-ok')">Cerrar</button>
  </div>
  <div class="modal-body">
    <div class="card" style="text-align:center">
      <img src="./assets/ok.png" alt="" style="height:80px;margin:10px auto 6px;opacity:.9"
           onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/5/5f/Yes_Check_Circle.svg/120px-Yes_Check_Circle.svg.png'">
      <p class="muted" style="margin:0 0 6px">Aquí verás tus números asignados. También enviamos el comprobante a tu correo.</p>
      <div id="nums" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:10px;margin-top:12px"></div>
      <div class="divider"></div>
      <button class="btn" onclick="window.location.hash='';closeModal('modal-ok')">Ir al inicio</button>
    </div>
  </div>
</dialog>

<!-- Firebase v10 (modular) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, collection, query, where, limit, getDocs, setDoc, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyByk16cSCI2VaLgQ4mV4dnr70NE4240XPY",
  authDomain: "sorteos-pro-venezuela.firebaseapp.com",
  projectId: "sorteos-pro-venezuela",
  storageBucket: "sorteos-pro-venezuela.firebasestorage.app",
  messagingSenderId: "119887004911",
  appId: "1:119887004911:web:125c6d1a3a06b2c5f3471a",
  measurementId: "G-926DZ7ZV57"
};

// === CONFIG USER ===
const GAS_UPLOAD_URL = "https://script.google.com/macros/s/AKfycbyfe88_IsXQIXl3bZ5Rnh9u8bHCkAUCKny913UlWngl8hBdQKGRE1XG2_85gxw37w0/exec";
const RAFFLE_ID = "raffle-001";
const PRICE_BS = 489;
const NUMBER_PAD = 4;

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let authReady = false;
let clicking = false;

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmtBs = v => 'Bs. ' + new Intl.NumberFormat('es-VE',{maximumFractionDigits:0}).format(v);

// Modal helpers
function openModal(id){ document.getElementById(id).showModal(); }
function closeModal(id){ document.getElementById(id).close(); }
// ← IMPORTANTE: exponer en window para que funcionen los onclick HTML
window.openModal = openModal;
window.closeModal = closeModal;

function updateTotal(){
  const q = Math.max(1, parseInt($('#qty').value.replace(/\D/g,''))||1);
  $('#qty').value = q;
  $('#total').textContent = fmtBs(q*PRICE_BS);
  $('#monto-exacto').textContent = fmtBs(q*PRICE_BS);
}
$('#minus').onclick = ()=>{ $('#qty').value = Math.max(1,(parseInt($('#qty').value)||1)-1); updateTotal(); };
$('#plus').onclick  = ()=>{ $('#qty').value = Math.min(999,(parseInt($('#qty').value)||1)+1); updateTotal(); };
$$('.chip').forEach(c=> c.onclick=()=>{ $('#qty').value=c.dataset.q; updateTotal(); });
updateTotal();

// saneo de números
['#ci','#tlf','#ci-emisor','#tlf-emisor','#ref6'].forEach(id=>{
  const el=$(id); if(!el) return;
  el.addEventListener('input',e=>{
    e.target.value = e.target.value.replace(/\D/g,'').slice(0, id==='#ref6'?6: (id.includes('tlf')?12:10));
  });
});

// Participar (espera auth)
$('#participar').onclick=()=>{
  if(!authReady){ alert('Conectando… inténtalo en unos segundos.'); return; }
  const today=new Date(); $('#fecha').value = today.toISOString().slice(0,10);
  openModal('modal-datos');
};
$('#ir-pago').onclick=()=>{
  const f=$('#form-datos');
  if(!f.checkValidity()){ f.reportValidity(); return; }
  closeModal('modal-datos'); openModal('modal-pago');
};

$('#confirmar').onclick = async ()=>{
  if(clicking) return;
  clicking=true; $('#confirmar').disabled=true; $('#confirmar').textContent='Procesando…';
  try{
    // 1) datos
    const qty = Math.max(1, parseInt($('#qty').value)||1);
    const buyer = {
      nombre: $('#nombre').value.trim(),
      correo: $('#correo').value.trim(),
      ci: $('#ci').value.trim(),
      tlf: $('#tlf').value.trim()
    };
    const pago = {
      banco: $('#banco-emisor').value,
      ci: $('#ci-emisor').value.trim(),
      tlf: $('#tlf-emisor').value.trim(),
      ref6: $('#ref6').value.trim(),
      fecha: $('#fecha').value
    };
    if(!buyer.nombre || !buyer.correo) throw new Error('Faltan tus datos');
    if(!/^\d{6}$/.test(pago.ref6)) throw new Error('Referencia inválida');
    const file = $('#file').files[0]; if(!file) throw new Error('Adjunta tu comprobante');

    // 2) subir comprobante (GAS)
    const fd = new FormData();
    fd.append('file', file, file.name);
    fd.append('email', buyer.correo);
    fd.append('folder', 'SorteosPRO_Comprobantes');
    const upRes = await fetch(GAS_UPLOAD_URL, { method:'POST', body:fd });
    if(!upRes.ok) throw new Error('No se pudo subir el comprobante');
    const up = await upRes.json();

    // 3) bloquear números disponibles
    const locked = [];
    for(let i=0;i<qty;i++){
      const q = query(collection(db,'raffles',RAFFLE_ID,'numbers'), where('status','==','available'), limit(1));
      const snap = await getDocs(q);
      if(snap.empty) throw new Error('No hay números disponibles');
      const ref = snap.docs[0].ref; const id = snap.docs[0].id;
      await updateDoc(ref, { status:'locked', assignedAt: serverTimestamp() });
      locked.push({id, ref});
    }

    // 4) crear orden
    const orderId = Math.random().toString(36).slice(2);
    await setDoc(doc(db,'orders',orderId), {
      raffleId: RAFFLE_ID,
      numbers: locked.map(n=>n.id),
      status: 'pending',
      buyer, payment:{...pago, comprobanteUrl: up.driveUrl},
      amountBs: qty*PRICE_BS, assignedAt: serverTimestamp()
    });

    // 5) marcar vendidos
    await Promise.all( locked.map(n=> updateDoc(n.ref, { status:'sold', orderId }) ) );

    // 6) mostrar
    const box=$('#nums'); box.innerHTML='';
    locked.forEach(n=>{
      const d=document.createElement('div');
      d.className='ticket'; d.textContent = n.id.padStart(NUMBER_PAD,'0');
      box.appendChild(d);
    });
    closeModal('modal-pago'); openModal('modal-ok');

  }catch(err){
    alert(err.message || 'No se pudo registrar el pago. Reintenta.');
  }finally{
    clicking=false; $('#confirmar').disabled=false; $('#confirmar').textContent='Confirmar y obtener números ahora';
  }
};

// Auth anónimo (bloqueante)
onAuthStateChanged(auth, async user=>{
  if(!user){
    try{ await signInAnonymously(auth); }
    catch(e){ $('#authState').textContent='Error al conectar. Recarga la página.'; return; }
  }else{
    authReady = true;
    $('#authState').textContent='Conectado. Listo para comprar.'; $('#participar').disabled=false;
  }
});
</script>
</body>
</html>
