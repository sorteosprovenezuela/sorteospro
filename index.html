<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sorteos PRO Venezuela</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéüÔ∏è</text></svg>">
  <meta name="color-scheme" content="dark light" />
  <link rel="preload" href="assets/promo.jpg" as="image" />
  <!-- ‚Ä¶ (deja los estilos tal cual del index anterior) ‚Ä¶ -->
</head>
‚Ä¶
<script>
  // ============== CONFIG ==============
  // ‚ö†Ô∏è Pega aqu√≠ tu URL /exec EXACTA del deployment ACTIVO (paso 2 de abajo)
  const API = "https://script.google.com/macros/s/AKfycbyfe88_IsXQIXl3bZ5Rnh9u8bHCkAUCKny913UlWngl8hBdQKGRE1XG2_85gxw37w0/exec";
  const RAFFLE_ID = "raffle-001";
  const PRICE_BS  = 489;

  // ============== Helpers ==============
  const $ = s => document.querySelector(s);
  const err = $("#err");
  const btn = $("#payBtn");
  const overlay = $("#overlay");
  const numsBox = $("#nums");

  function showErr(msg){
    err.textContent = msg;
    err.style.display = "block";
  }
  function clearErr(){ err.style.display="none"; err.textContent=""; }
  function closeModal(){ overlay.classList.remove("show"); window.scrollTo({top:0,behavior:"smooth"}); }

  // Fecha/hora
  (function(){
    const d = new Date();
    const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
    $("#date").value = `${yyyy}-${mm}-${dd}`;
    $("#hh").value = String(d.getHours()).padStart(2,"0");
    $("#mm").value = String(d.getMinutes()).padStart(2,"0");
    $("#total").textContent = PRICE_BS;
    $("#price").textContent = PRICE_BS;
  })();

  // Anti-doble click (20s)
  const SUBMIT_WINDOW_S = 20;
  function canSubmit(){
    const k="lastSubmitAt";
    const now=Date.now();
    const last=Number(localStorage.getItem(k)||0);
    if(now-last < SUBMIT_WINDOW_S*1000) return false;
    localStorage.setItem(k,String(now));
    return true;
  }

  async function submitOrder(){
    clearErr();
    if(!canSubmit()){ showErr("Ya estamos procesando tu pago. Espera unos segundos‚Ä¶"); return; }

    const file = $("#file").files[0] || null;
    const bank = $("#bank").value?.trim();
    const ci   = $("#ci").value?.trim();
    const tlf  = $("#tlf").value?.trim();
    const ref6 = $("#ref6").value?.trim();
    const date = $("#date").value?.trim();
    const hh   = $("#hh").value?.trim();
    const mm   = $("#mm").value?.trim();

    if(!file){ showErr("Debes subir el comprobante (JPG/PNG/HEIC, m√°x. 5 MB)."); return; }
    if(!/^\d{6}$/.test(ref6)){ showErr("Los √∫ltimos 6 d√≠gitos de la referencia no son v√°lidos."); return; }
    if(!/^\d{6,10}$/.test(ci)){ showErr("La c√©dula debe ser num√©rica (6-10 d√≠gitos)."); return; }
    if(!/^\d{10,12}$/.test(tlf)){ showErr("El tel√©fono debe ser num√©rico (10-12 d√≠gitos)."); return; }
    if(!/^\d{2}$/.test(hh) || !/^\d{2}$/.test(mm)){ showErr("Hora inv√°lida. Usa HH y MM."); return; }

    btn.disabled = true; btn.textContent = "Procesando‚Ä¶";

    try{
      const fd = new FormData();
      fd.append("action","createOrder");
      fd.append("raffleId", RAFFLE_ID);
      fd.append("priceBs", String(PRICE_BS));
      fd.append("bank", bank);
      fd.append("ci", ci);
      fd.append("tlf", tlf);
      fd.append("ref6", ref6);
      fd.append("date", date);
      fd.append("time", `${hh}:${mm}`);
      fd.append("file", file, file.name);

      const res = await fetch(`${API}?t=${Date.now()}`, { method:"POST", body:fd });
      let bodyText = "";
      try{ bodyText = await res.text(); }catch(e){ /* ignore */ }

      if(!res.ok){
        console.error("Apps Script error:", res.status, res.statusText, bodyText);
        throw new Error(`Servidor respondi√≥ ${res.status}. ${bodyText || "Intenta de nuevo."}`);
      }

      let data = {};
      try{ data = JSON.parse(bodyText); }catch(e){
        console.error("Respuesta no-JSON:", bodyText);
        throw new Error("Respuesta del servidor inv√°lida.");
      }

      if(!data.ok){
        console.error("Apps Script dijo !ok:", data);
        throw new Error(data.message || "No se pudo registrar el pago.");
      }

      // Mostrar n√∫meros
      numsBox.innerHTML = "";
      (data.numbers||[]).forEach(n=>{
        const b=document.createElement("div");
        b.className="badge";
        b.textContent = String(n).padStart(4,"0");
        numsBox.appendChild(b);
      });
      overlay.classList.add("show");

    }catch(e){
      showErr(e.message || "Error inesperado. Reintenta.");
    }finally{
      btn.disabled = false; btn.textContent = "Confirmar y obtener n√∫meros ahora";
    }
  }

  $("#payBtn").addEventListener("click", submitOrder);
  window.closeModal = closeModal;
</script>
