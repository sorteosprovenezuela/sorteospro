<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sorteos PRO Venezuela — US$ 10.000</title>
  <meta name="description" content="Participa por US$ 10.000. Tickets a Bs. 489. Sorteo 13/10/2025 por Lotería de Supergana." />
  <style>
    :root{
      --black:#0b0d0f; --black-2:#0e1114; --white:#fff; --muted:#94a3b8;
      --gold:#D4AF37; --green:#16a34a; --card:#111418; --border:#1f2937;
      --radius:16px; --shadow:0 8px 24px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--black);color:#e5e7eb;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;z-index:10;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);border-bottom:1px solid #151a21}
    .nav{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand b{letter-spacing:.06em}
    .btn{appearance:none;border:1px solid transparent;background:var(--green);color:#fff;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer;transition:.15s transform ease}
    .btn:hover{transform:translateY(-1px)}
    .btn.outline{background:transparent;border-color:var(--gold);color:var(--gold)}
    .btn.secondary{background:#0f172a;border-color:#243045}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .hero-img{border-radius:14px;overflow:hidden;aspect-ratio:16/9;background:#0b0d0f}
    h1{margin:10px 0 6px;font-size:clamp(22px,4.6vw,36px);color:#fff}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid #233042;background:#0b1117;color:#cbd5e1;padding:6px 10px;border-radius:999px;font-size:12px}
    .lead{color:#cbd5e1}
    .gold{color:var(--gold)}
    .divider{height:1px;background:#1f2937;margin:12px 0}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .qty{display:flex;align-items:center;gap:8px}
    .step{display:grid;grid-template-columns:1fr;gap:10px}
    .chips{display:grid;grid-template-columns:repeat(3,minmax(90px,1fr));gap:10px}
    .chip{padding:12px;border-radius:12px;background:#0e141c;border:1px solid #253245;text-align:center;font-weight:700;cursor:pointer}
    .chip[data-active="1"]{background:#0a4b2d;border-color:#1c7a4d;color:#d9f99d}
    .muted{color:#9aa6b2;font-size:13px}
    input,select,textarea{width:100%;background:#0c111a;border:1px solid #273244;color:#fff;padding:12px;border-radius:10px}
    input[type="file"]{padding:10px}
    .price{font-weight:900;font-size:clamp(22px,3.4vw,28px);color:var(--gold)}
    footer{border-top:1px solid #171b22;padding:24px 0;margin-top:24px;color:#a1a7b0;font-size:13px}

    /* Modal */
    dialog{border:none;border-radius:18px;background:#0c1116;color:#fff;max-width:940px;width:calc(100% - 24px);box-shadow:var(--shadow)}
    dialog::backdrop{background:rgba(0,0,0,.75)}
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #1a2432}
    .modal-body{padding:16px}
    .cols{display:grid;gap:12px}
    @media (min-width: 880px){ .cols{grid-template-columns:1fr 1fr}}
    .note{background:#0b1219;border:1px dashed #2a3649;color:#cbd5e1;border-radius:12px;padding:10px;font-size:13px}

    /* Ticket / Gracias */
    .ticket{display:grid;place-items:center;gap:16px;padding:18px}
    .ticket h2{margin:6px 0 0}
    .nums{display:grid;grid-template-columns:repeat(auto-fit,minmax(98px,1fr));gap:10px;margin-top:10px}
    .num{border:1px solid #213046;background:#0b1320;border-radius:12px;padding:12px 14px;text-align:center;font-weight:900;letter-spacing:.12em}

    /* Helper */
    .hidden{display:none!important}
    .fullw{width:100%}
  </style>
</head>
<body>
<header>
  <div class="wrap nav">
    <div class="brand">
      <img src="assets/logo.png" alt="Sorteos PRO" style="height:32px;width:auto"/>
      <b>Sorteos PRO</b>
    </div>
    <a class="btn outline" href="https://t.me/" target="_blank" rel="noopener">Telegram</a>
  </div>
</header>

<main class="wrap">
  <section class="grid">
    <div class="card">
      <div class="hero-img">
        <!-- Sube tu foto a /assets/hero.jpg en GitHub -->
        <img src="assets/hero.jpg" alt="Promo del sorteo">
      </div>
      <div style="padding:10px 4px 4px">
        <span class="pill">Lotería de Supergana • 13 Oct 2025</span>
        <h1>Sorteo <span class="gold">US$ 10.000</span></h1>
        <p class="lead">Tickets a <span class="gold">Bs. <span id="priceBs">489</span></span>. 10.000 números únicos (0000–9999).</p>
      </div>
      <div class="divider"></div>
      <div style="padding:6px 4px 10px">
        <div class="row"><b class="gold">Elige tus boletos</b></div>
        <div class="row" style="margin:10px 0 10px">
          <div class="qty">
            <button id="minus" class="btn secondary">−</button>
            <input id="qty" inputmode="numeric" pattern="\d*" value="1" style="width:86px;text-align:center;font-weight:800"/>
            <button id="plus" class="btn secondary">+</button>
          </div>
        </div>
        <div class="chips" style="margin-bottom:10px">
          <div class="chip" data-q="1">1</div>
          <div class="chip" data-q="2">2<span class="muted" style="display:block;font-size:12px">Más popular</span></div>
          <div class="chip" data-q="5">5</div>
          <div class="chip" data-q="10">10</div>
          <div class="chip" data-q="25">25</div>
          <div class="chip" data-q="50">50</div>
        </div>
        <div class="row">
          <div>
            <div class="muted">Total a pagar</div>
            <div class="price" id="total">Bs. 489</div>
          </div>
          <button id="btnParticipar" class="btn">Participar</button>
        </div>
        <p class="note" style="margin-top:10px">Al continuar, subirás tu captura y recibirás <b>al instante</b> números aleatorios. Si el pago no coincide, el administrador puede liberarlos.</p>
      </div>
    </div>

    <aside class="card">
      <p style="margin:0 0 6px;font-weight:800">Detalles del sorteo</p>
      <div class="step">
        <div class="row" style="justify-content:space-between"><span>Premio</span><b>US$ 10.000</b></div>
        <div class="row" style="justify-content:space-between"><span>Fecha</span><b>13/10/2025</b></div>
        <div class="row" style="justify-content:space-between"><span>Organiza</span><b>Lotería de Supergana</b></div>
        <div class="row" style="justify-content:space-between"><span>Números</span><b>0000–9999</b></div>
        <div class="row" style="justify-content:space-between"><span>Precio</span><b>Bs. <span id="priceBs2">489</span></b></div>
      </div>
      <p class="muted" style="margin-top:8px">Conserva la captura de tus números.</p>
    </aside>
  </section>
</main>

<footer class="wrap">© 2025 Sorteos PRO Venezuela</footer>

<!-- MODAL: Pago -->
<dialog id="dlgPago">
  <div class="modal-head">
    <strong>Pago Móvil</strong>
    <button class="btn outline" id="btnClosePago">Cerrar</button>
  </div>
  <div class="modal-body">
    <div class="cols">
      <!-- Paso 1 -->
      <div class="card">
        <h3 style="margin:0 0 8px">1) Datos del beneficiario</h3>
        <div class="row" style="justify-content:space-between"><span>Monto exacto</span><b id="montoExacto">Bs. 0</b></div>
        <div class="divider"></div>
        <div class="step">
          <div class="row" style="justify-content:space-between"><span>Banco</span><b>Banco Provincial</b></div>
          <div class="row" style="justify-content:space-between"><span>Teléfono</span><b>04244150022</b></div>
          <div class="row" style="justify-content:space-between"><span>Cédula</span><b>15857050</b></div>
          <p class="muted">Haz el Pago Móvil por el monto exacto y guarda el comprobante.</p>
        </div>
      </div>

      <!-- Paso 2 -->
      <div class="card">
        <h3 style="margin:0 0 8px">2) Sube tu comprobante</h3>
        <input id="fileComp" type="file" accept="image/jpeg,image/png,image/heic,image/heif" />
        <p class="muted">JPG/PNG/HEIC • máx 5 MB</p>
      </div>

      <!-- Paso 3 -->
      <div class="card">
        <h3 style="margin:0 0 8px">3) Reporta tu pago</h3>
        <label>Banco emisor</label>
        <select id="bancoEmisor">
          <option>Banco de Venezuela</option><option>Banco Provincial</option><option>Banesco</option><option>Mercantil</option><option>Banco Nacional de Crédito</option><option>Bancamiga</option><option>Mi Banco</option><option>Banco del Tesoro</option><option>Exterior</option>
        </select>
        <label style="margin-top:8px">Cédula (solo números)</label>
        <input id="ci" inputmode="numeric" maxlength="10" placeholder="15857050" />
        <label>Teléfono</label>
        <input id="tlf" inputmode="tel" maxlength="12" placeholder="04244150022" />
        <label>Últimos 6 de la referencia</label>
        <input id="ref6" inputmode="numeric" pattern="\d{6}" maxlength="6" placeholder="123456" />
        <label>Fecha del pago</label>
        <input id="fecha" type="date" />
        <div class="divider"></div>
        <button id="btnConfirmar" class="btn fullw">Confirmar y obtener números ahora</button>
        <p id="hintPerms" class="muted hidden" style="margin-top:6px;color:#fca5a5">Missing or insufficient permissions. Verifica reglas Firestore (ver guía).</p>
      </div>
    </div>
  </div>
</dialog>

<!-- MODAL: Gracias / Números -->
<dialog id="dlgOk">
  <div class="modal-head">
    <strong>Compra aprobada 🎉</strong>
    <button class="btn outline" id="btnCloseOk">Cerrar</button>
  </div>
  <div class="modal-body ticket">
    <img src="assets/logo.png" alt="Logo" style="height:42px;opacity:.9">
    <h2>¡Listo, números asignados!</h2>
    <div id="outRaffleName" class="muted"></div>
    <div class="nums" id="numsBox"></div>
    <div class="divider" style="width:100%"></div>
    <button class="btn" id="btnVolver">Ir al inicio</button>
  </div>
</dialog>

<!-- Firebase SDK (compat para simpleza) -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
(function(){
  // ------------------ CONFIG ------------------
  const RAFFLE_ID = 'raffle-001';
  const PRICE_BS = 489;
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyfe88_IsXQIXl3bZ5Rnh9u8bHCkAUCKny913UlWngl8hBdQKGRE1XG2_85gxw37w0/exec';

  // Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyByk16cSCI2VaLgQ4mV4dnr70NE4240XPY",
    authDomain: "sorteos-pro-venezuela.firebaseapp.com",
    projectId: "sorteos-pro-venezuela",
    storageBucket: "sorteos-pro-venezuela.firebasestorage.app",
    messagingSenderId: "119887004911",
    appId: "1:119887004911:web:125c6d1a3a06b2c5f3471a",
    measurementId: "G-926DZ7ZV57"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ------------------ HELPERS ------------------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const sleep = ms => new Promise(r => setTimeout(r,ms));
  const fmtBs = v => 'Bs. ' + new Intl.NumberFormat('es-VE',{maximumFractionDigits:0}).format(v);

  // Estado UI
  const qtyEl = $('#qty'), totalEl = $('#total'), priceEls = [$('#priceBs'), $('#priceBs2')];
  priceEls.forEach(e => e.textContent = PRICE_BS);
  function setQty(q){ q = Math.min(999, Math.max(1, parseInt(q||'1',10))); qtyEl.value = q; totalEl.textContent = fmtBs(q*PRICE_BS); $('#montoExacto').textContent = fmtBs(q*PRICE_BS); }
  setQty(1);
  $('#plus').onclick = ()=> setQty((parseInt(qtyEl.value)||1)+1);
  $('#minus').onclick = ()=> setQty((parseInt(qtyEl.value)||2)-1);
  qtyEl.oninput = ()=> setQty(qtyEl.value);
  $$('.chip').forEach(ch => ch.addEventListener('click', ()=> setQty(ch.dataset.q)));

  // Modales
  const dlgPago = $('#dlgPago'), dlgOk = $('#dlgOk');
  $('#btnParticipar').onclick = async () => {
    if(!auth.currentUser) await anonIn();
    // Prerelleno de fecha hoy
    const t = new Date(), y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,'0'), d=String(t.getDate()).padStart(2,'0');
    $('#fecha').value = `${y}-${m}-${d}`;
    dlgPago.showModal();
  };
  $('#btnClosePago').onclick = ()=> dlgPago.close();
  $('#btnCloseOk').onclick = ()=> dlgOk.close();
  $('#btnVolver').onclick = ()=> { dlgOk.close(); window.scrollTo({top:0,behavior:'smooth'}); };

  // Validaciones simples
  $('#ci').addEventListener('input',e=> e.target.value=e.target.value.replace(/\D/g,'').slice(0,10));
  $('#tlf').addEventListener('input',e=> e.target.value=e.target.value.replace(/\D/g,'').slice(0,12));
  $('#ref6').addEventListener('input',e=> e.target.value=e.target.value.replace(/\D/g,'').slice(0,6));

  // Login anónimo
  async function anonIn(){
    try{ await auth.signInAnonymously(); }
    catch(e){ console.error(e); alert('No se pudo iniciar sesión anónima. Reintenta.'); }
  }

  // Anti doble envío
  let busy = false;
  function lock(btn, txt='Procesando...'){ busy=true; btn.dataset.prev=btn.textContent; btn.textContent=txt; btn.disabled=true; }
  function unlock(btn){ busy=false; btn.textContent=btn.dataset.prev||'Continuar'; btn.disabled=false; }

  // ------------------ FLUJO PRINCIPAL ------------------
  $('#btnConfirmar').onclick = async () => {
    const btn = $('#btnConfirmar');
    if(busy) return;
    $('#hintPerms').classList.add('hidden');

    // Validar
    const q = Math.max(1, parseInt(qtyEl.value)||1);
    const banco = $('#bancoEmisor').value.trim();
    const ci = $('#ci').value.trim();
    const tlf = $('#tlf').value.trim();
    const ref6 = $('#ref6').value.trim();
    const fecha = $('#fecha').value;
    const file = $('#fileComp').files[0];

    if(!file){ alert('Sube tu comprobante (imagen).'); return; }
    if(!/^\d{6}$/.test(ref6)){ alert('Coloca los últimos 6 de la referencia.'); return; }
    if(!ci || !tlf || !fecha){ alert('Completa todos los datos.'); return; }

    // Bloquear UI
    lock(btn, 'Procesando...');
    try{
      if(!auth.currentUser) await anonIn();
      const uid = auth.currentUser.uid;

      // 1) Subir comprobante a Apps Script (devuelve URL)
      const fd = new FormData();
      fd.append('file', file);
      fd.append('raffleId', RAFFLE_ID);
      fd.append('qty', String(q));
      fd.append('banco', banco);
      fd.append('ci', ci);
      fd.append('tlf', tlf);
      fd.append('ref6', ref6);
      fd.append('fecha', fecha);
      fd.append('uid', uid);
      let upResp;
      try{
        const r = await fetch(APPS_SCRIPT_URL, { method:'POST', body: fd, mode:'cors' });
        upResp = await r.json();
        if(!upResp || !upResp.ok) throw new Error('Upload failed');
      }catch(e){
        console.error('Apps Script', e);
        alert('No se pudo subir el comprobante. Reintenta.');
        unlock(btn); return;
      }
      const compUrl = upResp.url;

      // 2) Crear orden pending
      const orderRef = db.collection('orders').doc();
      const orderData = {
        uid, raffleId: RAFFLE_ID, qty: q, amountBs: q*PRICE_BS,
        buyer: { ci, tlf }, banco, ref6, fecha,
        comprobanteUrl: compUrl,
        status: 'pending',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      await orderRef.set(orderData);

      // 3) Buscar disponibles y transaccionar asignación
      const numsRef = db.collection('raffles').doc(RAFFLE_ID).collection('numbers');
      const snapAvail = await numsRef.where('status','==','available').limit(q*2).get(); // cogemos de más por si hay colisiones
      if(snapAvail.empty){ throw new Error('No hay números disponibles.'); }

      const picked = await db.runTransaction(async (tx) => {
        const chosen = [];
        // volvemos a leer dentro de la tx cada doc
        for(const d of snapAvail.docs){
          if(chosen.length>=q) break;
          const ref = d.ref;
          const cur = await tx.get(ref);
          if(cur.exists && cur.data().status === 'available'){
            tx.update(ref, { status:'assigned', orderId: orderRef.id });
            chosen.push(ref.id);
          }
        }
        if(chosen.length < q) throw new Error('Stock insuficiente, intenta de nuevo.');
        tx.update(orderRef, {
          status:'assigned',
          numbers: chosen,
          assignedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        return chosen;
      });

      // 4) Mostrar ticket
      $('#outRaffleName').textContent = 'Sorteo US$ 10.000 — 13/10/2025';
      $('#numsBox').innerHTML = picked
        .sort()
        .map(n => `<div class="num">${n}</div>`)
        .join('');
      dlgPago.close();
      dlgOk.showModal();

    } catch(e){
      console.error(e);
      if(String(e).includes('permission') || String(e).includes('PERMISSION')){
        $('#hintPerms').classList.remove('hidden');
      }
      alert('No se pudo registrar el pago. Revisa e intenta de nuevo.');
    } finally {
      unlock(btn);
    }
  };

  // auto-login anónimo al cargar
  auth.onAuthStateChanged(u => { if(!u) anonIn(); });

})();
</script>
</body>
</html>
