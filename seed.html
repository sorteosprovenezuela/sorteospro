<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sembrar números — Admin</title>
  <style>
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;margin:0;background:#0b0d0f;color:#e5e7eb}
    .wrap{max-width:800px;margin:40px auto;padding:0 16px}
    .card{background:#111418;border:1px solid #222;border-radius:12px;padding:16px}
    input,button{padding:10px;border-radius:8px;border:1px solid #333;background:#0d121a;color:#fff}
    .btn{cursor:pointer;background:#D4AF37;color:#111;border:none;font-weight:700}
    .muted{color:#9aa6b2}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    progress{width:100%;height:16px}
    code{background:#0d121a;border:1px solid #273244;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
<div class="wrap">
  <h2>Sembrar números 0000–9999 para <code>raffle-001</code></h2>

  <div class="card">
    <p class="muted">1) Inicia sesión con tu <b>usuario admin</b> (debe existir un documento en <code>admins/{UID}</code>).  
    2) Pulsa <b>Sembrar</b> una sola vez. Si se corta, vuelve a entrar y repite: el script <u>saltará los ya existentes</u>.</p>

    <div class="row" style="margin-bottom:8px">
      <input id="email" type="email" placeholder="Email admin">
      <input id="pass" type="password" placeholder="Contraseña">
      <button id="btn-login" class="btn">Entrar</button>
      <span id="me" class="muted"></span>
    </div>

    <div class="row" style="margin-bottom:8px">
      <label>Rifa: <code id="raffleId">raffle-001</code></label>
      <button id="btn-seed" class="btn" disabled>Sembrar 0000–9999</button>
    </div>

    <progress id="bar" value="0" max="10000"></progress>
    <div class="row" style="margin-top:8px;justify-content:space-between">
      <span id="status" class="muted">Esperando inicio de sesión…</span>
      <span id="counters" class="muted"></span>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3>Comprobaciones</h3>
    <ol>
      <li>Luego de “Listo”, en Firestore ve a <code>raffles → raffle-001 → numbers</code> y verifica que existan documentos como <code>0000</code>, <code>0001</code>, …, <code>9999</code> con <code>status: "available"</code>.</li>
      <li>Si el proceso se interrumpe, vuelve a pulsar “Sembrar”: sólo creará los que falten.</li>
      <li>No abras esta página en dos pestañas a la vez.</li>
    </ol>
  </div>
</div>

<script type="module">
  // ======== TU CONFIG DE FIREBASE ========
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, writeBatch, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyByk16cSCI2VaLgQ4mV4dnr70NE4240XPY",
    authDomain: "sorteos-pro-venezuela.firebaseapp.com",
    projectId: "sorteos-pro-venezuela",
    storageBucket: "sorteos-pro-venezuela.firebasestorage.app",
    messagingSenderId: "119887004911",
    appId: "1:119887004911:web:125c6d1a3a06b2c5f3471a"
  };

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // ======== UI helpers ========
  const $ = s => document.querySelector(s);
  const bar = $('#bar'), statusEl = $('#status'), counters = $('#counters'), btnSeed = $('#btn-seed'), me = $('#me');
  const RAFFLE_ID = 'raffle-001';
  const PAD = 4;             // 0000…9999
  const START = 0, END = 9999;
  const BATCH_SIZE = 400;    // lote de escrituras por commit

  $('#btn-login').addEventListener('click', async ()=>{
    try{
      await signInWithEmailAndPassword(auth, $('#email').value.trim(), $('#pass').value);
    }catch(e){ alert('Error de acceso'); console.error(e); }
  });

  onAuthStateChanged(auth, async (u)=>{
    if(!u){ btnSeed.disabled = true; me.textContent = ''; statusEl.textContent = 'Esperando inicio de sesión…'; return; }
    me.textContent = u.email || u.uid;

    // Verifica permisos de admin
    const isAdmin = (await getDoc(doc(db,'admins',u.uid))).exists();
    if(!isAdmin){
      statusEl.textContent = 'Este usuario no es admin. Sal de la sesión y entra con un admin.';
      btnSeed.disabled = true;
      return;
    }
    statusEl.textContent = 'Listo. Puedes sembrar.';
    btnSeed.disabled = false;
  });

  btnSeed.addEventListener('click', async ()=>{
    if(!confirm('¿Sembrar 0000–9999 en raffles/'+RAFFLE_ID+'? Hazlo una sola vez.')) return;
    btnSeed.disabled = true;

    try{
      let created = 0, skipped = 0, i = START;

      // También guarda metadatos en el doc principal de la rifa
      await setDoc(doc(db,'raffles',RAFFLE_ID), {
        numberPad: PAD, range: {start: START, end: END}, totalNumbers: (END-START+1)
      }, { merge:true });

      while(i <= END){
        const batch = writeBatch(db);
        let writes = 0;

        // Lote
        for(; writes < BATCH_SIZE && i <= END; i++){
          const id = String(i).padStart(PAD,'0');
          const ref = doc(db, `raffles/${RAFFLE_ID}/numbers/${id}`);

          // Si ya existe, lo saltamos (no rompemos estados sold/assigned)
          const snap = await getDoc(ref);
          if(snap.exists()){
            skipped++;
          }else{
            batch.set(ref, {
              status: 'available',
              createdAt: serverTimestamp()
            });
            writes++;
            created++;
          }

          bar.value = i - START + 1; // progreso visual
          counters.textContent = `Creados: ${created} • Omitidos: ${skipped} • Progreso: ${i-START+1}/10000`;
        }

        if(writes > 0){
          statusEl.textContent = `Escribiendo lote…`;
          await batch.commit();
        }
      }

      statusEl.textContent = `✅ Listo. Creados: ${created} — Omitidos: ${skipped}`;
      alert('Sembrado completado. Revisa Firestore → raffles → raffle-001 → numbers.');

    }catch(err){
      console.error(err);
      statusEl.textContent = '❌ Hubo un error. Puedes recargar y reintentar; los ya existentes se omiten.';
      btnSeed.disabled = false;
    }
  });
</script>
</body>
</html>
